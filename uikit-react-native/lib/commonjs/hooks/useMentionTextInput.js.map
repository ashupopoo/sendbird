{"version":3,"names":["_react","require","_reactNative","_uikitUtils","_useContext","useMentionTextInput","params","mentionManager","useSendbirdChat","mentionedUsersRef","useRef","textInputRef","text","setText","useState","selection","setSelection","start","end","useEffect","shouldUseMentionedMessageTemplate","messageToEdit","result","templateToTextAndMentionedUsers","mentionedMessageTemplate","mentionedUsers","current","mentionedText","_params$messageToEdit","isUserMessage","message","onChangeText","useFreshCallback","_nextText","addedMentionedUser","prevText","nextText","offset","length","push","reconcileRangeOfMentionedUsers","filtered","lastSelection","removeMentionedUsersInSelection","Math","max","foundIndex","findIndex","it","rangeHelpers","overlaps","range","remainderLength","replace","splice","onSelectionChange","e","nativeSelection","nativeEvent","setTimeout","mentionedUser","find","_textInputRef$current","selectionBlock","setNativeProps","Platform","OS","_textInputRef$current2","_default","exports","default"],"sources":["useMentionTextInput.ts"],"sourcesContent":["import { useEffect, useRef, useState } from 'react';\nimport type { NativeSyntheticEvent, TextInput, TextInputSelectionChangeEventData } from 'react-native';\nimport { Platform } from 'react-native';\n\nimport { SendbirdFileMessage, SendbirdUserMessage, replace, useFreshCallback } from '@sendbird/uikit-utils';\n\nimport type { MentionedUser } from '../types';\nimport { useSendbirdChat } from './useContext';\n\nconst useMentionTextInput = (params: { messageToEdit?: SendbirdUserMessage | SendbirdFileMessage }) => {\n  const { mentionManager } = useSendbirdChat();\n\n  const mentionedUsersRef = useRef<MentionedUser[]>([]);\n  const textInputRef = useRef<TextInput>();\n\n  const [text, setText] = useState('');\n  const [selection, setSelection] = useState({ start: 0, end: 0 });\n\n  // TODO: Refactor text edit logic more clearly\n  useEffect(() => {\n    if (mentionManager.shouldUseMentionedMessageTemplate(params.messageToEdit)) {\n      const result = mentionManager.templateToTextAndMentionedUsers(\n        params.messageToEdit.mentionedMessageTemplate,\n        params.messageToEdit.mentionedUsers,\n      );\n\n      mentionedUsersRef.current = result.mentionedUsers;\n      setText(result.mentionedText);\n    } else {\n      mentionedUsersRef.current = [];\n      if (params.messageToEdit?.isUserMessage()) {\n        setText(params.messageToEdit.message);\n      }\n    }\n  }, [params.messageToEdit]);\n\n  const onChangeText = useFreshCallback((_nextText: string, addedMentionedUser?: MentionedUser) => {\n    const prevText = text;\n    let nextText = _nextText;\n    let offset = nextText.length - prevText.length;\n\n    // Text clear\n    if (nextText === '') {\n      mentionedUsersRef.current = [];\n    }\n    // Text add\n    else if (offset > 0) {\n      /** Add mentioned user **/\n      if (addedMentionedUser) mentionedUsersRef.current.push(addedMentionedUser);\n\n      /** Reconcile mentioned users range on the right side of the selection **/\n      mentionedUsersRef.current = mentionManager.reconcileRangeOfMentionedUsers(\n        offset,\n        selection.end,\n        mentionedUsersRef.current,\n      );\n    }\n    // Text remove\n    else if (offset < 0) {\n      // Ranged remove\n      if (selection.start !== selection.end) {\n        /** Filter mentioned users in selection range **/\n        const { filtered, lastSelection } = mentionManager.removeMentionedUsersInSelection(\n          selection,\n          mentionedUsersRef.current,\n        );\n\n        /** Reconcile mentioned users range on the right side of the selection **/\n        mentionedUsersRef.current = mentionManager.reconcileRangeOfMentionedUsers(\n          offset,\n          Math.max(selection.end, lastSelection),\n          filtered,\n        );\n      }\n      // Single remove\n      else {\n        /** Find mentioned user who ranges in removed selection **/\n        const foundIndex = mentionedUsersRef.current.findIndex((it) =>\n          mentionManager.rangeHelpers.overlaps(it.range, selection, 'underMore'),\n        );\n        /** If found, remove from the mentioned user list and remove remainder text **/\n        if (foundIndex > -1) {\n          const it = mentionedUsersRef.current[foundIndex];\n          const remainderLength = it.range.end - it.range.start + offset;\n\n          offset = -remainderLength + offset;\n          nextText = replace(nextText, it.range.start, it.range.start + remainderLength, '');\n\n          mentionedUsersRef.current.splice(foundIndex, 1);\n        }\n\n        /** Reconcile mentioned users range on the right side of the selection **/\n        mentionedUsersRef.current = mentionManager.reconcileRangeOfMentionedUsers(\n          offset,\n          selection.end,\n          mentionedUsersRef.current,\n        );\n      }\n    }\n\n    setText(nextText);\n  });\n\n  return {\n    textInputRef,\n    selection,\n    onSelectionChange: useFreshCallback((e: NativeSyntheticEvent<TextInputSelectionChangeEventData>) => {\n      const nativeSelection = { ...e.nativeEvent.selection };\n\n      // NOTE: To synchronize call onSelectionChange after onChangeText called on each platform.\n      setTimeout(() => {\n        const mentionedUser = mentionedUsersRef.current.find((it) =>\n          mentionManager.rangeHelpers.overlaps(it.range, nativeSelection),\n        );\n\n        // Selection should be blocked if changed into mentioned area\n        if (mentionedUser) {\n          const selectionBlock = { start: mentionedUser.range.start, end: mentionedUser.range.end };\n          textInputRef.current?.setNativeProps({ selection: selectionBlock });\n          // BUG: setNativeProps called again when invoked onChangeText\n          //  https://github.com/facebook/react-native/issues/33520\n          if (Platform.OS === 'android') {\n            setTimeout(() => {\n              textInputRef.current?.setNativeProps({ selection: { start: 0 } });\n            }, 250);\n          }\n          setSelection(selectionBlock);\n        } else {\n          setSelection(nativeSelection);\n        }\n      }, 10);\n    }),\n    text,\n    onChangeText,\n    mentionedUsers: mentionedUsersRef.current,\n  };\n};\n\nexport default useMentionTextInput;\n"],"mappings":"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"}